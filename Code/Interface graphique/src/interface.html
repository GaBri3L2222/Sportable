<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appli Sport Fonctionnelle</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f4;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .title {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }

        .card {
            background-color: white;
            border: 2px solid #2c3e50;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .forms-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            background-color: #fafafa;
        }

        .form-group h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .form-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .form-row:last-child {
            margin-bottom: 0;
        }

        .form-row label {
            flex: 0 0 120px;
            font-weight: 500;
            color: #555;
            font-size: 14px;
        }

        .form-row select,
        .form-row .spinbox {
            flex: 1;
        }

        select {
            width: 100%;
            padding: 5px;
            border: 1px solid #8c8c8c;
            border-radius: 5px;
            font-size: 14px;
        }

        .spinbox {
            display: flex;
            align-items: center;
            border: 1px solid #8c8c8c;
            border-radius: 5px;
            background-color: white;
        }

        .spinbox input {
            flex: 1;
            border: none;
            text-align: center;
            padding: 5px;
            font-size: 14px;
            outline: none;
        }

        .spinbox button {
            width: 30px;
            height: 30px;
            border: none;
            background-color: #e0e0e0;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: background-color 0.2s;
        }

        .spinbox button:hover {
            background-color: #d0d0d0;
        }

        .spinbox button:first-child {
            border-radius: 5px 0 0 5px;
        }

        .spinbox button:last-child {
            border-radius: 0 5px 5px 0;
        }

        button {
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            transition: opacity 0.2s;
        }

        button:hover {
            opacity: 0.9;
        }

        .btn-green {
            background-color: #3e7d23;
            color: white;
            width: 100%;
            margin-top: 10px;
        }

        .btn-red {
            background-color: #c92a42;
            color: white;
            text-transform: uppercase;
            width: 100%;
            padding: 15px;
            font-size: 16px;
        }

        .separator {
            height: 1px;
            background-color: #ddd;
            margin: 20px 0;
        }

        .list-label {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .exercise-list {
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            background-color: white;
            margin-bottom: 15px;
        }

        .exercise-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .exercise-item:hover {
            background-color: #f0f0f0;
        }

        .exercise-item.selected {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .exercise-item:last-child {
            border-bottom: none;
        }

        /* Execution View */
        .exercise-name {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
            padding: 15px;
            background-color: #e8f4f8;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .execution-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .progress-info {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #ddd;
        }

        .progress-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .progress-row:last-child {
            margin-bottom: 0;
        }

        .display-value {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }

        .section-label {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .vision-indicator {
            border: 2px solid;
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .vision-active {
            border-color: green;
            background-color: #e8f5e9;
            color: green;
        }

        .vision-inactive {
            border-color: red;
            background-color: #ffebee;
            color: red;
        }

        .feedback-display {
            min-height: 80px;
            padding: 15px;
            background-color: #fff9e6;
            border: 1px solid #ffe082;
            border-radius: 10px;
            word-wrap: break-word;
            font-size: 14px;
        }

        .rest-time-container {
            text-align: center;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 10px;
            border: 1px solid #ddd;
        }

        .rest-time-container .display-value {
            font-size: 24px;
            color: #2c3e50;
        }

        .skeleton-panel {
            display: flex;
            flex-direction: column;
        }

        .skeleton-label {
            font-weight: bold;
            font-size: 12pt;
            margin-bottom: 10px;
        }

        #skeletonCanvas {
            background-color: #f0f0f0;
            border: 2px solid #2c3e50;
            border-radius: 15px;
            width: 100%;
            height: 500px;
        }

        .exercise-counter {
            text-align: center;
            font-weight: bold;
            font-size: 11pt;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 8px;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 1200px) {
            .execution-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .forms-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- Configuration View -->
    <div id="configView">
        <h1 class="title">Configuration - Ajouter des Exercices et des Pauses</h1>

        <div class="card">
            <div class="forms-row">
                <!-- Exercise Form -->
                <div class="form-group">
                    <h3>Exercice</h3>
                    <div class="form-row">
                        <label>Exercice :</label>
                        <select id="exerciseName">
                            <option value="pompes">pompes</option>
                            <option value="squats">squats</option>
                            <option value="jumping_jacks">jumping_jacks</option>
                            <option value="lever_jambes">lever_jambes</option>
                            <option value="montee_genou">montee_genou</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label>Répétitions :</label>
                        <div class="spinbox">
                            <button onclick="changeValue('reps', -1)">−</button>
                            <input type="number" id="reps" value="10" min="1" max="100" readonly>
                            <button onclick="changeValue('reps', 1)">+</button>
                        </div>
                    </div>
                    <div class="form-row">
                        <label>Séries :</label>
                        <div class="spinbox">
                            <button onclick="changeValue('sets', -1)">−</button>
                            <input type="number" id="sets" value="3" min="1" max="20" readonly>
                            <button onclick="changeValue('sets', 1)">+</button>
                        </div>
                    </div>
                    <button class="btn-green" onclick="addExercise()">Ajouter l'exercice</button>
                </div>

                <!-- Rest Form -->
                <div class="form-group">
                    <h3>Pause</h3>
                    <div class="form-row">
                        <label>Durée (secondes) :</label>
                        <div class="spinbox">
                            <button onclick="changeValue('restDuration', -5)">−</button>
                            <input type="number" id="restDuration" value="30" min="5" max="600" step="5" readonly>
                            <button onclick="changeValue('restDuration', 5)">+</button>
                        </div>
                    </div>
                    <button class="btn-green" onclick="addRest()">Ajouter la pause</button>
                </div>
            </div>

            <div class="separator"></div>

            <div class="list-label">Séquence configurée :</div>
            <div class="exercise-list" id="exerciseList"></div>

            <button class="btn-green" onclick="deleteSelected()">Supprimer l'élément sélectionné</button>

            <div style="margin-top: 15px;">
                <button class="btn-red" onclick="startWorkout()">Démarrer l'entraînement</button>
            </div>
        </div>
    </div>

    <!-- Execution View -->
    <div id="executionView" class="hidden">
        <h1 class="title">Exercice en cours</h1>

        <div class="card">
            <div class="exercise-name" id="currentExerciseName">En attente...</div>

            <div class="separator"></div>

            <div class="execution-container">
                <!-- Left Panel -->
                <div class="left-panel">
                    <!-- Progress Info -->
                    <div class="progress-info">
                        <div class="progress-row">
                            <span>Répétitions restantes:</span>
                            <span class="display-value" id="repsRemaining">0</span>
                        </div>
                        <div class="progress-row">
                            <span>Séries restantes:</span>
                            <span class="display-value" id="setsRemaining">0</span>
                        </div>
                    </div>

                    <!-- Vision State -->
                    <div>
                        <div class="section-label">Vision:</div>
                        <div id="visionIndicator" class="vision-indicator vision-inactive">✗ Vision Inactive</div>
                    </div>

                    <!-- Feedback -->
                    <div>
                        <div class="section-label">Feedback:</div>
                        <div class="feedback-display" id="feedbackDisplay">En attente de feedback...</div>
                    </div>

                    <div class="separator"></div>

                    <!-- Rest Time -->
                    <div class="rest-time-container">
                        <div style="margin-bottom: 5px;">Temps de repos:</div>
                        <div class="display-value" id="restTime">0s</div>
                    </div>

                    <!-- Exercise Counter -->
                    <div class="exercise-counter" id="exerciseCounter">Élément 0 / 0</div>

                    <!-- Stop Button -->
                    <button class="btn-red" onclick="stopWorkout()">Quitter</button>
                </div>

                <!-- Right Panel - Skeleton -->
                <div class="skeleton-panel">
                    <div class="skeleton-label">Visualisation du squelette:</div>
                    <canvas id="skeletonCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // MediaPipe Pose connections - exact same as Python
        const POSE_CONNECTIONS = [
            // Face
            [0, 1], [1, 2], [2, 3], [3, 7],
            [0, 4], [4, 5], [5, 6], [6, 8],
            [9, 10],
            // Torso
            [11, 12], [11, 23], [12, 24], [23, 24],
            // Left arm
            [11, 13], [13, 15], [15, 17], [15, 19], [15, 21], [17, 19],
            // Right arm
            [12, 14], [14, 16], [16, 18], [16, 20], [16, 22], [18, 20],
            // Left leg
            [23, 25], [25, 27], [27, 29], [27, 31], [29, 31],
            // Right leg
            [24, 26], [26, 28], [28, 30], [28, 32], [30, 32]
        ];

        let selectedIndex = -1;
        let currentSkeletonData = null;
        let updateInterval = null;

        // Spinbox helpers
        function changeValue(id, delta) {
            const input = document.getElementById(id);
            const min = parseInt(input.min) || 0;
            const max = parseInt(input.max) || 1000;
            const step = id === 'restDuration' ? 5 : 1;
            let value = parseInt(input.value) + delta;
            value = Math.max(min, Math.min(max, value));
            input.value = value;
        }

        // Add exercise
        function addExercise() {
            const name = document.getElementById('exerciseName').value;
            const reps = parseInt(document.getElementById('reps').value);
            const sets = parseInt(document.getElementById('sets').value);

            if (typeof pywebview !== 'undefined') {
                pywebview.api.add_exercise(name, reps, sets).then(() => {
                    updateExerciseList();
                });
            } else {
                console.log('Add exercise:', name, reps, sets);
                updateExerciseList();
            }
        }

        // Add rest
        function addRest() {
            const duration = parseInt(document.getElementById('restDuration').value);

            if (typeof pywebview !== 'undefined') {
                pywebview.api.add_rest(duration).then(() => {
                    updateExerciseList();
                });
            } else {
                console.log('Add rest:', duration);
                updateExerciseList();
            }
        }

        // Delete selected
        function deleteSelected() {
            if (selectedIndex >= 0) {
                if (typeof pywebview !== 'undefined') {
                    pywebview.api.remove_exercise(selectedIndex).then(() => {
                        selectedIndex = -1;
                        updateExerciseList();
                    });
                } else {
                    console.log('Delete index:', selectedIndex);
                    selectedIndex = -1;
                    updateExerciseList();
                }
            }
        }

        // Update exercise list
        function updateExerciseList() {
            if (typeof pywebview !== 'undefined') {
                pywebview.api.get_exercises().then(exercises => {
                    renderExerciseList(exercises);
                });
            } else {
                // Demo mode
                renderExerciseList([]);
            }
        }

        function renderExerciseList(exercises) {
            const listEl = document.getElementById('exerciseList');
            listEl.innerHTML = '';

            exercises.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'exercise-item';
                if (index === selectedIndex) {
                    div.className += ' selected';
                }

                if (item.type === 'exercice') {
                    div.textContent = `${item.nom} — ${item.repetitions} reps x ${item.series} séries`;
                } else if (item.type === 'pause') {
                    div.textContent = `Repos — ${item.duree_secondes} s`;
                }

                div.onclick = () => {
                    selectedIndex = index;
                    updateExerciseList();
                };

                listEl.appendChild(div);
            });
        }

        // Start workout
        function startWorkout() {
            if (typeof pywebview !== 'undefined') {
                pywebview.api.start_workout().then(() => {
                    showExecutionView();
                });
            } else {
                showExecutionView();
            }
        }

        // Stop workout
        function stopWorkout() {
            if (typeof pywebview !== 'undefined') {
                pywebview.api.stop_workout().then(() => {
                    showConfigView();
                });
            } else {
                showConfigView();
            }
        }

        function showConfigView() {
            document.getElementById('executionView').classList.add('hidden');
            document.getElementById('configView').classList.remove('hidden');
            stopUpdateLoop();
            updateExerciseList();
        }

        function showExecutionView() {
            document.getElementById('configView').classList.add('hidden');
            document.getElementById('executionView').classList.remove('hidden');
            startUpdateLoop();
        }

        // Update loop for execution view
        function startUpdateLoop() {
            if (updateInterval) clearInterval(updateInterval);
            updateInterval = setInterval(updateExecutionView, 500);
            updateExecutionView();
        }

        function stopUpdateLoop() {
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
        }

        // Update execution view
        function updateExecutionView() {
            if (typeof pywebview !== 'undefined') {
                pywebview.api.get_execution_state().then(state => {
                    renderExecutionState(state);
                });
            } else {
                // Demo mode
                renderExecutionState({
                    current_exercise_name: 'Demo Exercise',
                    reps_remaining: 0,
                    sets_remaining: 0,
                    vision_state: false,
                    feedback: 'En attente de feedback...',
                    rest_time: 0,
                    current_index: 0,
                    total_exercises: 0,
                    skeleton_data: null
                });
            }
        }

        function renderExecutionState(state) {
            // Update exercise name
            document.getElementById('currentExerciseName').textContent =
                state.current_exercise_name || 'En attente...';

            // Update reps/sets
            document.getElementById('repsRemaining').textContent = state.reps_remaining || 0;
            document.getElementById('setsRemaining').textContent = state.sets_remaining || 0;

            // Update vision state
            const visionEl = document.getElementById('visionIndicator');
            if (state.vision_state) {
                visionEl.className = 'vision-indicator vision-active';
                visionEl.textContent = '✓ Vision Active';
            } else {
                visionEl.className = 'vision-indicator vision-inactive';
                visionEl.textContent = '✗ Vision Inactive';
            }

            // Update feedback
            document.getElementById('feedbackDisplay').textContent =
                state.feedback || 'En attente de feedback...';

            // Update rest time
            document.getElementById('restTime').textContent =
                (state.rest_time || 0) + 's';

            // Update counter
            document.getElementById('exerciseCounter').textContent =
                `Élément ${state.current_index + 1} / ${state.total_exercises}`;

            // Update skeleton
            if (state.skeleton_data) {
                drawSkeleton(state.skeleton_data);
            }
        }

        // Draw skeleton on canvas - matches PyQt5 SkeletonWidget
        function drawSkeleton(skeletonJson) {
            try {
                const data = typeof skeletonJson === 'string' ? JSON.parse(skeletonJson) : skeletonJson;
                currentSkeletonData = data;

                const canvas = document.getElementById('skeletonCanvas');
                const ctx = canvas.getContext('2d');
                const rect = canvas.getBoundingClientRect();

                // Set canvas size
                canvas.width = rect.width;
                canvas.height = rect.height;

                // Clear canvas
                ctx.fillStyle = '#f0f0f0';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                const landmarks = data.landmarks || [];
                if (landmarks.length === 0) {
                    ctx.fillStyle = '#646464';
                    ctx.font = '16px Segoe UI';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('En attente du squelette...', canvas.width / 2, canvas.height / 2);
                    return;
                }

                // Filter visible landmarks
                const visibleLandmarks = landmarks.filter(lm => (lm.visibility || 0) > 0.5);
                if (visibleLandmarks.length === 0) {
                    ctx.fillStyle = '#646464';
                    ctx.font = '16px Segoe UI';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('Aucun point visible', canvas.width / 2, canvas.height / 2);
                    return;
                }

                // Calculate bounds
                const xCoords = visibleLandmarks.map(lm => lm.x);
                const yCoords = visibleLandmarks.map(lm => lm.y);
                const minX = Math.min(...xCoords);
                const maxX = Math.max(...xCoords);
                const minY = Math.min(...yCoords);
                const maxY = Math.max(...yCoords);

                const dataWidth = maxX - minX;
                const dataHeight = maxY - minY;

                if (dataWidth === 0 || dataHeight === 0) return;

                const padding = 40;
                const scaleX = (canvas.width - 2 * padding) / dataWidth;
                const scaleY = (canvas.height - 2 * padding) / dataHeight;
                const scale = Math.min(scaleX, scaleY);

                const offsetX = padding - minX * scale + (canvas.width - 2 * padding - dataWidth * scale) / 2;
                const offsetY = padding - minY * scale + (canvas.height - 2 * padding - dataHeight * scale) / 2;

                function transform(landmark) {
                    return {
                        x: landmark.x * scale + offsetX,
                        y: landmark.y * scale + offsetY
                    };
                }

                // Draw connections
                ctx.strokeStyle = 'rgb(70, 130, 180)'; // Steel blue
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';

                POSE_CONNECTIONS.forEach(([startIdx, endIdx]) => {
                    if (startIdx < landmarks.length && endIdx < landmarks.length) {
                        const startLm = landmarks[startIdx];
                        const endLm = landmarks[endIdx];

                        if ((startLm.visibility || 0) > 0.5 && (endLm.visibility || 0) > 0.5) {
                            const start = transform(startLm);
                            const end = transform(endLm);

                            ctx.beginPath();
                            ctx.moveTo(start.x, start.y);
                            ctx.lineTo(end.x, end.y);
                            ctx.stroke();
                        }
                    }
                });

                // Draw landmarks
                landmarks.forEach((landmark, i) => {
                    const visibility = landmark.visibility || 0;
                    if (visibility > 0.5) {
                        const point = transform(landmark);

                        // Color by body part (matches PyQt5 logic)
                        let color;
                        if (i >= 0 && i <= 10) { // Face
                            color = `rgba(255, 100, 100, ${visibility})`;
                        } else if (i >= 11 && i <= 22) { // Arms
                            color = `rgba(100, 255, 100, ${visibility})`;
                        } else if (i >= 23 && i <= 24) { // Hips
                            color = `rgba(255, 255, 100, ${visibility})`;
                        } else { // Legs
                            color = `rgba(100, 100, 255, ${visibility})`;
                        }

                        ctx.fillStyle = color;
                        ctx.strokeStyle = 'rgb(50, 50, 50)';
                        ctx.lineWidth = 1;

                        ctx.beginPath();
                        ctx.arc(point.x, point.y, 5, 0, 2 * Math.PI);
                        ctx.fill();
                        ctx.stroke();
                    }
                });

                // Draw info text at bottom
                ctx.fillStyle = 'rgb(50, 50, 50)';
                ctx.font = 'bold 10pt Segoe UI';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'bottom';
                const infoText = `Stage: ${data.stage || ''}${data.feedback ? ' | ' + data.feedback : ''}`;
                ctx.fillText(infoText, 10, canvas.height - 10);

            } catch (e) {
                console.error('Error drawing skeleton:', e);
            }
        }

        // Initialize on load
        window.addEventListener('pywebviewready', function () {
            updateExerciseList();
        });

        // Handle window resize for canvas
        window.addEventListener('resize', function () {
            if (currentSkeletonData) {
                drawSkeleton(currentSkeletonData);
            }
        });

        // Initial load
        if (typeof pywebview !== 'undefined') {
            updateExerciseList();
        }
    </script>
</body>

</html>